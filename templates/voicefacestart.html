<script>
        class ChatApp {
            constructor() {
                this.initializeElements();
                this.setupEventListeners();
                this.userData = null;
                this.isRecording = false;
                this.startFaceRecognition();
            }

            initializeElements() {
                // Auth elements
                this.initialAuth = document.getElementById('initialAuth');
                this.authCameraPreview = document.getElementById('authCameraPreview');
                this.mainContainer = document.getElementById('mainContainer');
                
                // Chat elements
                this.chatMessages = document.getElementById('chatMessages');
                this.textInput = document.getElementById('textInput');
                this.sendButton = document.getElementById('sendButton');
                this.voiceButton = document.getElementById('voiceButton');
                this.loading = document.getElementById('loading');
                this.userInfo = document.getElementById('userInfo');
                this.userName = document.getElementById('userName');
                this.userType = document.getElementById('userType');
                this.audioBars = document.getElementById('audioBars');

                // Create audio bars
                for (let i = 0; i < 50; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    bar.style.height = '0%';
                    this.audioBars.appendChild(bar);
                }
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.voiceButton.addEventListener('click', () => this.toggleVoiceRecording());
                this.textInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            async startFaceRecognition() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    this.authCameraPreview.srcObject = stream;

                    // Wait for camera warmup
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Get face recognition data
                    const response = await fetch('./start', {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });

                    if (!response.ok) throw new Error('Face recognition failed');

                    const data = await response.json();
                    if (!data.recognition || !data.recognition.name) {
                        throw new Error('Face not recognized');
                    }

                    // Store user data
                    this.userData = {
                        name: data.recognition.name,
                        userType: data.recognition.class || 'staff'
                    };

                    // Update UI
                    this.userName.textContent = this.userData.name;
                    this.userType.textContent = this.userData.userType;
                    this.userInfo.classList.add('active');

                    // Clean up camera
                    stream.getTracks().forEach(track => track.stop());
                    this.authCameraPreview.srcObject = null;

                    // Show main interface
                    this.initialAuth.classList.add('hidden');
                    this.mainContainer.style.display = 'grid';

                } catch (error) {
                    console.error('Face recognition error:', error);
                    alert('Face recognition failed. Please try again.');
                    location.reload();
                }
            }

            async toggleVoiceRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                    return;
                }

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.isRecording = true;
                    this.voiceButton.style.backgroundColor = 'red';
                    this.voiceButton.textContent = 'â¹ï¸';
                    this.startAudioVisualization();

                    // Start voice recognition
                    const response = await fetch('./start', {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });

                    if (!response.ok) throw new Error('Voice recognition failed');

                    const data = await response.json();
                    if (data.recognition && data.recognition.message) {
                        this.textInput.value = data.recognition.message;
                    }

                } catch (error) {
                    console.error('Voice recording error:', error);
                    this.addErrorMessage('Voice recording failed: ' + error.message);
                    this.stopRecording();
                }
            }

            stopRecording() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.isRecording = false;
                this.voiceButton.style.backgroundColor = '';
                this.voiceButton.textContent = 'ðŸŽ¤';

                Array.from(this.audioBars.children).forEach(bar => {
                    bar.style.height = '0%';
                });
            }

            startAudioVisualization() {
                if (!this.stream) return;

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(this.stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 128;

                source.connect(analyser);
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const updateBars = () => {
                    if (!this.isRecording) {
                        audioContext.close();
                        return;
                    }

                    analyser.getByteFrequencyData(dataArray);
                    const bars = Array.from(this.audioBars.children);
                    const step = Math.ceil(bufferLength / bars.length);

                    bars.forEach((bar, index) => {
                        const dataIndex = index * step;
                        const value = dataArray[dataIndex] / 255.0;
                        bar.style.height = `${value * 100}%`;
                    });

                    requestAnimationFrame(updateBars);
                };

                updateBars();
            }

            async sendMessage() {
                const message = this.textInput.value.trim();
                if (!message || !this.userData) return;

                this.addMessage(message, 'user');
                this.textInput.value = '';

                this.loading.classList.add('active');

                try {
                    const response = await fetch('https://primary-production-5212.up.railway.app/webhook/chat/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: this.userData.name,
                            userType: this.userData.userType,
                            message: message
                        })
                    });

                    if (!response.ok) throw new Error('API request failed');

                    const data = await response.json();
                    if (data.response) {
                        this.addMarkdownMessage(data.response);
                    }

                } catch (error) {
                    console.error('API error:', error);
                    this.addErrorMessage('Failed to get response: ' + error.message);
                } finally {
                    this.loading.classList.remove('active');
                }
            }

            addMessage(text, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                contentDiv.textContent = text;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time';
                timeDiv.textContent = new Date().toLocaleTimeString();
                
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(timeDiv);
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            addMarkdownMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message markdown';
                messageDiv.innerHTML = marked.parse(text);
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            addErrorMessage(text) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = text;
                this.chatMessages.appendChild(errorDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.chatApp = new ChatApp();
        });
    </script>
</body>
</html>
